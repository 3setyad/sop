<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator PDF Dinamis dengan Flowchart Mermaid.js</title>
    
    <!-- 1. Import Materialize CSS & Google Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Menambahkan library Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
        }

        /* --- STYLING UNTUK FORM INPUT (Materialize Framework) --- */
        .container {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        h4.form-title {
            font-weight: 300;
            text-align: center;
            margin-bottom: 30px;
        }
        h5.form-section-title {
            font-size: 1.3rem;
            font-weight: 400;
            color: #0d47a1; /* Darker blue */
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        .action-buttons {
            margin-top: 30px;
        }
        
        /* Styling kustom untuk tabel di dalam form Materialize */
        .form-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .form-table th, .form-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
        }
        .form-table th {
            font-weight: bold;
            color: #424242;
        }
        .form-table input, .form-table select {
            /* Menggunakan gaya default browser di dalam tabel agar lebih ringkas */
            border: 1px solid #ccc !important;
            height: 2.5rem !important;
            padding: 0 5px !important;
            border-radius: 3px;
            background-color: white !important;
        }
        .form-table input:focus, .form-table select:focus {
             border-color: #2196F3 !important;
             box-shadow: none !important;
        }
        .form-table input[readonly] {
            background-color: #f5f5f5 !important;
            cursor: not-allowed;
            color: #757575;
        }
        .form-table .btn-small {
            padding: 0 1rem;
        }

        /* --- STYLING UNTUK PRATINJAU PDF (Tidak Diubah, Sesuai Aslinya) --- */
        #pdfPreviewContent {
            background-color: white;
            padding: 20mm;
            width: 210mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            margin: 20px auto;
        }
        #topSectionGrid { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; margin-bottom: 10px; }
        #leftColumnContent { flex: 0 0 55%; padding-right: 5mm; box-sizing: border-box; text-align: center; }
        #rightColumnContent { flex: 0 0 45%; padding-left: 5mm; box-sizing: border-box; text-align: left; font-size: 10px; }
        .logo-kemenag { width: 70px; height: auto; display: block; margin: 0 auto 5px auto; }
        .header-section h1 { font-size: 11px; margin: 0; line-height: 1.2; color: #333; }
        .header-section h2 { font-size: 9px; margin: 0; line-height: 1.2; color: #555; font-weight: normal; }
        .info-table { width: 100%; border-collapse: collapse; margin-top: 0; }
        .info-table td { padding: 1px 0; vertical-align: top; }
        .info-table td:first-child { width: 100px; font-weight: normal; }
        .info-table td:nth-child(2) { width: 5px; text-align: center; }
        .info-table td:last-child { font-weight: bold; }
        .footer-signer { margin-top: 5px; margin-bottom: 2px; line-height: 1.3; }
        .footer-signer p { margin: 0; }
        #sopTitleContainer { border: 1px solid #000; padding: 5px; text-align: center; font-size: 10px; font-weight: bold; background-color: #b5b5b5; margin-top: 10px; box-sizing: border-box; width: 100%; }
        .table-like-section { display: grid; grid-template-columns: 1fr 1fr; border: 1px solid #000; border-top: none; margin-bottom: 0px; box-sizing: border-box; width: 100%; }
        .table-like-section .col-header { border-bottom: 1px solid #000; padding: 5px; font-size: 10px; font-weight: bold; background-color: #b5b5b5; text-align: center; }
        .table-like-section .col-header:first-child { border-right: 1px solid #000; }
        .table-like-section .col-content { padding: 5px; font-size: 9px; border-right: 1px solid #000; min-height: 30px; }
        .table-like-section .col-content:last-child { border-right: none; }
        .table-like-section .col-content ol { padding-left: 12px; margin: 0; }
        .table-like-section .col-content li { margin-bottom: 2px; line-height: 1.2; }
        .table-like-section .col-content p { margin: 0; line-height: 1.3; }
        .activity-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 9px; }
        .activity-table th, .activity-table td { border: 1px solid #000; padding: 4px; text-align: left; vertical-align: top; }
        .activity-table th { background-color: #b5b5b5; font-weight: bold; text-align: center; }
        .preview-section-title { font-size: 12px; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000; background-color: #b5b5b5; margin-top: 10px; }
        #flowchartPreviewContainer { padding: 10px; border: 1px solid #000; border-top: none; font-size: 10px; text-align: center; }
        .mermaid text { font-family: Arial, sans-serif !important; font-size: 10px !important; }
        .mermaid .edgeLabel { font-size: 9px !important; font-style: italic; }
        .pdf-render-wrapper { position: absolute; left: -9999px; top: 0; width: 900px; background-color: white; padding: 20px; }
    </style>
</head>
<body>

    <!-- FORM HTML (Struktur Materialize) -->
    <div class="container">
      <div class="card-panel z-depth-2" id="input-form">
        <h4 class="form-title">Form Input Data SOP</h4>

        <h5 class="form-section-title">Informasi Dokumen & Penanda Tangan</h5>
        <div class="row">
            <div class="input-field col s12 m6"><i class="material-icons prefix">business</i><input type="text" id="form-satuan-kerja" value="SEKRETARIAT JENDERAL"><label for="form-satuan-kerja">Nama Satuan Kerja</label></div>
            <div class="input-field col s12 m6"><i class="material-icons prefix">group_work</i><input type="text" id="form-unit-kerja" value="BIRO ORGANISASI DAN TATALAKSANA"><label for="form-unit-kerja">Nama Unit Kerja / Tim Kerja</label></div>
            <div class="input-field col s12 m6"><i class="material-icons prefix">folder_open</i><input type="text" id="form-nomor" value="Kw.12.1/4763.1/OT/06/2024"><label for="form-nomor">Nomor Dokumen</label></div>
            <div class="input-field col s12 m6"><i class="material-icons prefix">event</i><input type="text" id="form-tgl-pembuatan" class="datepicker"><label for="form-tgl-pembuatan">Tanggal Pembuatan</label></div>
            <div class="input-field col s12 m6"><i class="material-icons prefix">event</i><input type="text" id="form-tgl-revisi" class="datepicker"><label for="form-tgl-revisi">Tanggal Revisi</label></div>
            <div class="input-field col s12 m6"><i class="material-icons prefix">event</i><input type="text" id="form-tgl-efektif" class="datepicker"><label for="form-tgl-efektif">Tanggal Efektif</label></div>
            <div class="input-field col s12"><i class="material-icons prefix">work</i><input type="text" id="form-jabatan" value="Kepala Bagian Tata Usaha Kanwil Kemenag DIY"><label for="form-jabatan">Jabatan Penanda Tangan</label></div>
            <div class="input-field col s12 m6"><i class="material-icons prefix">account_circle</i><input type="text" id="form-signer-name" value="Muntolib, S.Ag.M.S."><label for="form-signer-name">Nama Penanda Tangan</label></div>
            <div class="input-field col s12 m6"><i class="material-icons prefix">fingerprint</i><input type="text" id="form-signer-nip" value="197204242002121003"><label for="form-signer-nip">NIP Penanda Tangan</label></div>
        </div>
        
        <h5 class="form-section-title">Judul Utama SOP</h5>
        <div class="row">
            <div class="input-field col s12"><i class="material-icons prefix">title</i><input type="text" id="form-sop-title" value="SOP PENYUSUNAN ANALIS JABATAN ANALIS BEBAN KERJA KUALIFIKASI PELAKSANA"><label for="form-sop-title">Judul SOP</label></div>
        </div>

        <h5 class="form-section-title">Detail Konten</h5>
        <div class="row">
            <div class="input-field col s12"><i class="material-icons prefix">gavel</i><textarea id="form-dasar-hukum" class="materialize-textarea">Keputusan Menteri Pendayagunaan Aparatur Sipil Negara RB Nomor 656 Tahun 2023 tentang Nomenklatur Jabatan Pelaksana Instansi Pemerintah</textarea><label for="form-dasar-hukum">Dasar Hukum</label><span class="helper-text">Masukkan satu item per baris.</span></div>
            <div class="input-field col s12"><i class="material-icons prefix">school</i><textarea id="form-kualifikasi" class="materialize-textarea">Memahami tugas dan fungsi Kementerian Agama</textarea><label for="form-kualifikasi">Kualifikasi Pelaksana</label><span class="helper-text">Masukkan satu item per baris.</span></div>
            <div class="input-field col s12"><i class="material-icons prefix">link</i><textarea id="form-keterkaitan" class="materialize-textarea">SOP Pembuatan SK/Surat Tugas Tim Kerja</textarea><label for="form-keterkaitan">Keterkaitan</label><span class="helper-text">Masukkan satu item per baris.</span></div>
            <div class="input-field col s12"><i class="material-icons prefix">build</i><textarea id="form-peralatan" class="materialize-textarea">Term Of Reference (TOR)</textarea><label for="form-peralatan">Peralatan/Perlengkapan</label><span class="helper-text">Masukkan satu item per baris.</span></div>
            <div class="input-field col s12"><i class="material-icons prefix">warning</i><textarea id="form-peringatan" class="materialize-textarea">Jika tidak memiliki pemahaman yang baik terkait jabatan dan beban kerja Kementerian Agama akan menghambat penerapan jabatan dan beban kerja yang tidak sesuai di lingkungan Kementerian Agama</textarea><label for="form-peringatan">Peringatan</label></div>
            <div class="input-field col s12"><i class="material-icons prefix">archive</i><textarea id="form-pencatatan" class="materialize-textarea">Disimpan dalam data elektronik dan manual</textarea><label for="form-pencatatan">Pencatatan/Pendataan</label></div>
        </div>

        <h5 class="form-section-title">Tabel Rincian Kegiatan</h5>
        <div class="row">
            <div class="col s12">
                <table id="form-activity-table" class="form-table">
                    <thead><tr><th>Kegiatan</th><th>Pelaksana</th><th>Kelengkapan</th><th>Waktu</th><th>Output</th><th>Keterangan</th><th>Aksi</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-activity-row-btn" class="btn-small blue waves-effect waves-light" style="margin-top: 15px;"><i class="material-icons left">add</i>Tambah</button>
            </div>
        </div>

        <h5 class="form-section-title">Tabel Alur Flowchart</h5>
        <div class="row">
            <div class="col s12">
                <table id="form-flowchart-table" class="form-table responsive-table">
                    <thead><tr><th style="width: 5%;">ID</th><th style="width: 25%;">Kegiatan</th><th style="width: 15%;">Pelaksana</th><th style="width: 15%;">Node</th><th style="width: 10%;">ID Tujuan</th><th style="width: 10%;">ID 'Ya'</th><th style="width: 10%;">ID 'Tidak'</th><th style="width: 10%;">Aksi</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-flowchart-row-btn" class="btn-small blue waves-effect waves-light" style="margin-top: 15px;"><i class="material-icons left">add</i>Tambah</button>
            </div>
        </div>
      </div>
    </div>
    
    <div class="container center-align action-buttons">
      <div class="row">
        <div class="col s12 m6">
          <button id="updatePreviewBtn" class="btn-large green waves-effect waves-light" style="width:100%"><i class="material-icons right">update</i>Update Pratinjau</button>
        </div>
        <div class="col s12 m6">
          <button id="generatePdfFromHtml" class="btn-large blue waves-effect waves-light" style="width:100%"><i class="material-icons right">picture_as_pdf</i>Generate PDF</button>
        </div>
      </div>
    </div>

    <!-- Pratinjau PDF (Tidak diubah) -->
    <div id="pdfPreviewContent">
        <div id="topSectionGrid"><div id="leftColumnContent"><img src="https://upload.wikimedia.org/wikipedia/commons/9/9a/Kementerian_Agama_new_logo.png" alt="Logo Kementerian Agama" class="logo-kemenag"><div class="header-section"><h1>KEMENTERIAN AGAMA REPUBLIK INDONESIA</h1><h2 id="preview-satuan-kerja"></h2><h2 id="preview-unit-kerja"></h2></div></div><div id="rightColumnContent"><table class="info-table" id="infoTableData"><tr><td>Nomor</td><td>:</td><td id="preview-nomor"></td></tr><tr><td>Tanggal Pembuatan</td><td>:</td><td id="preview-tgl-pembuatan"></td></tr><tr><td>Tanggal Revisi</td><td>:</td><td id="preview-tgl-revisi"></td></tr><tr><td>Tanggal Efektif</td><td>:</td><td id="preview-tgl-efektif"></td></tr></table><div class="footer-signer"><p>Disahkan Oleh</p><p id="preview-jabatan"></p><br><br><br><br></div><div class="footer-signer"><p id="preview-signer-name"></p><p id="preview-signer-nip"></p></div></div></div>
        <div id="sopTitleContainer"></div>
        <div class="table-like-section"><div class="col-header">DASAR HUKUM</div><div class="col-header">KUALIFIKASI PELAKSANA</div><div class="col-content"><ol class="section-content" id="dasarHukumList"></ol></div><div class="col-content"><ol class="section-content" id="kualifikasiPelaksanaList"></ol></div></div>
        <div class="table-like-section"><div class="col-header">KETERKAITAN</div><div class="col-header">PERALATAN/PERLENGKAPAN</div><div class="col-content"><ol class="section-content" id="keterkaitanList"></ol></div><div class="col-content"><ol class="section-content" id="peralatanList"></ol></div></div>
        <div class="table-like-section"><div class="col-header">PERINGATAN</div><div class="col-header">PENCATATAN/PENDATAAN</div><div class="col-content"><p class="section-content" id="peringatanText"></p></div><div class="col-content"><p class="section-content" id="pencatatanText"></p></div></div>
        <table class="activity-table" id="activityTableData"><thead><tr><th rowspan="2">No</th><th rowspan="2">Kegiatan</th><th rowspan="2">Pelaksana</th><th colspan="3">Mutu Baku</th><th rowspan="2">Keterangan</th></tr><tr><th>Kelengkapan</th><th>Waktu</th><th>Output</th></tr></thead><tbody></tbody></table>
        <div class="preview-section-title">ALUR FLOWCHART</div>
        <div id="flowchartPreviewContainer"></div>
    </div>

    <!-- 2. Import Libraries JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        // 3. Inisialisasi Komponen Materialize dan Kode Aplikasi
        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi semua komponen Materialize secara otomatis
            M.AutoInit();
            
            // Set format untuk datepicker
            const datePickers = document.querySelectorAll('.datepicker');
            datePickers.forEach(picker => {
                const instance = M.Datepicker.getInstance(picker);
                instance.options.format = 'd mmmm yyyy';
            });
            
            // --- Kode Aplikasi Anda (Tidak diubah) ---
            mermaid.initialize({ startOnLoad: false, theme: 'neutral' });

            const formActivityTableBody = document.querySelector('#form-activity-table tbody');
            const initialActivityData = [
                { kegiatan: 'Membuat konsep jadwal pelaksanaan', pelaksana: 'Analis Tata Laksana', kelengkapan: 'TOR, RAB', waktu: '60 menit', output: 'Draft Jadwal', keterangan: 'Koordinasi Awal' }
            ];
            initialActivityData.forEach(data => addActivityRow(data));
            
            formActivityTableBody.addEventListener('input', () => {
                updateFlowchartChoices();
            });

            // Inisialisasi awal untuk pratinjau
            updatePreview(); 
        });


        const { jsPDF } = window.jspdf;
        let activityDataCache = [];
        let nextFlowchartId = 1;

        const formActivityTableBody = document.querySelector('#form-activity-table tbody');
        document.getElementById('add-activity-row-btn').addEventListener('click', () => {
            addActivityRow();
            updateFlowchartChoices();
        });

        function addActivityRow(data = {}) {
            const row = formActivityTableBody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-kegiatan" value="${data.kegiatan || ''}"></td>
                <td><input type="text" class="form-pelaksana" value="${data.pelaksana || ''}"></td>
                <td><input type="text" class="form-kelengkapan" value="${data.kelengkapan || ''}"></td>
                <td><input type="text" class="form-waktu" value="${data.waktu || ''}"></td>
                <td><input type="text" class="form-output" value="${data.output || ''}"></td>
                <td><input type="text" class="form-keterangan" value="${data.keterangan || ''}"></td>
                <td><button type="button" class="btn-small red waves-effect waves-light remove-row-btn"><i class="material-icons">delete</i></button></td>
            `;
            row.querySelector('.remove-row-btn').addEventListener('click', () => {
                row.remove();
                updateFlowchartChoices();
            });
        };

        const formFlowchartTableBody = document.querySelector('#form-flowchart-table tbody');
        document.getElementById('add-flowchart-row-btn').addEventListener('click', () => {
            addFlowchartRow();
            updateFlowchartChoices();
        });

        formFlowchartTableBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('form-flow-kegiatan')) {
                const selectedKegiatan = e.target.value;
                const correspondingActivity = activityDataCache.find(act => act.kegiatan === selectedKegiatan);
                const pelaksanaInput = e.target.closest('tr').querySelector('.form-flow-pelaksana');
                if (correspondingActivity) {
                    pelaksanaInput.value = correspondingActivity.pelaksana;
                } else {
                    pelaksanaInput.value = '';
                }
            }
        });

        function addFlowchartRow() {
            const row = formFlowchartTableBody.insertRow();
            row.innerHTML = `
                <td><input type="number" class="form-flow-id" value="${nextFlowchartId}" readonly></td>
                <td><select class="form-flow-kegiatan browser-default"></select></td>
                <td><input type="text" class="form-flow-pelaksana" readonly></td>
                <td>
                    <select class="form-flow-node browser-default">
                        <option value="awal">Awal</option>
                        <option value="proses" selected>Proses</option>
                        <option value="keputusan">Keputusan</option>
                        <option value="akhir">Akhir</option>
                    </select>
                </td>
                <td><input type="text" class="form-flow-idtujuan" value=""></td>
                <td><input type="text" class="form-flow-idy" value=""></td>
                <td><input type="text" class="form-flow-idt" value=""></td>
                <td><button type="button" class="btn-small red waves-effect waves-light remove-row-btn"><i class="material-icons">delete</i></button></td>
            `;
            nextFlowchartId++;
            toggleFlowchartInputs(row.querySelector('.form-flow-node'));
            row.querySelector('.remove-row-btn').addEventListener('click', () => row.remove());
            row.querySelector('.form-flow-node').addEventListener('change', (e) => {
                toggleFlowchartInputs(e.target);
            });
        }
        
        function updateFlowchartChoices() {
            activityDataCache = Array.from(formActivityTableBody.querySelectorAll('tr')).map(row => ({
                kegiatan: row.querySelector('.form-kegiatan').value,
                pelaksana: row.querySelector('.form-pelaksana').value
            }));

            const flowchartSelects = formFlowchartTableBody.querySelectorAll('.form-flow-kegiatan');
            flowchartSelects.forEach(select => {
                const previouslySelected = select.value;
                select.innerHTML = '<option value="" disabled selected>Pilih Kegiatan</option>';
                activityDataCache.forEach(data => {
                    if (data.kegiatan) {
                        const option = document.createElement('option');
                        option.value = data.kegiatan;
                        option.textContent = data.kegiatan;
                        select.appendChild(option);
                    }
                });
                select.value = previouslySelected;
            });
        }

        function toggleFlowchartInputs(selectElement) {
            const row = selectElement.closest('tr');
            const idTujuanInput = row.querySelector('.form-flow-idtujuan');
            const idYInput = row.querySelector('.form-flow-idy');
            const idTInput = row.querySelector('.form-flow-idt');

            if (selectElement.value === 'keputusan') {
                idTujuanInput.readOnly = true; idTujuanInput.value = '';
                idYInput.readOnly = false; idTInput.readOnly = false;
            } else {
                idTujuanInput.readOnly = false;
                idYInput.readOnly = true; idYInput.value = '';
                idTInput.readOnly = true; idTInput.value = '';
            }
        }

        const updatePreviewBtn = document.getElementById('updatePreviewBtn');

        const updatePreview = async () => {
            document.getElementById('preview-satuan-kerja').textContent = document.getElementById('form-satuan-kerja').value.toUpperCase();
            document.getElementById('preview-unit-kerja').textContent = document.getElementById('form-unit-kerja').value.toUpperCase();
            document.getElementById('preview-nomor').textContent = document.getElementById('form-nomor').value;
            
            const formatDate = (dateString) => {
                 if (!dateString) return '';
                 return dateString;
            };

            document.getElementById('preview-tgl-pembuatan').textContent = formatDate(document.getElementById('form-tgl-pembuatan').value);
            document.getElementById('preview-tgl-revisi').textContent = formatDate(document.getElementById('form-tgl-revisi').value);
            document.getElementById('preview-tgl-efektif').textContent = formatDate(document.getElementById('form-tgl-efektif').value);
            
            document.getElementById('preview-jabatan').textContent = document.getElementById('form-jabatan').value;
            document.getElementById('preview-signer-name').textContent = document.getElementById('form-signer-name').value;
            document.getElementById('preview-signer-nip').textContent = `NIP ${document.getElementById('form-signer-nip').value}`;
            document.getElementById('sopTitleContainer').textContent = document.getElementById('form-sop-title').value.toUpperCase();

            const updateListFromTextarea = (textareaId, listId) => {
                const textareaValue = document.getElementById(textareaId).value;
                const listContainer = document.getElementById(listId);
                const items = textareaValue.split('\n').filter(item => item.trim() !== '');
                listContainer.innerHTML = items.map(item => `<li>${item}</li>`).join('');
            };

            updateListFromTextarea('form-dasar-hukum', 'dasarHukumList');
            updateListFromTextarea('form-kualifikasi', 'kualifikasiPelaksanaList');
            updateListFromTextarea('form-keterkaitan', 'keterkaitanList');
            updateListFromTextarea('form-peralatan', 'peralatanList');

            document.getElementById('peringatanText').textContent = document.getElementById('form-peringatan').value;
            document.getElementById('pencatatanText').textContent = document.getElementById('form-pencatatan').value;
            
            const previewActivityTableBody = document.querySelector('#activityTableData tbody');
            previewActivityTableBody.innerHTML = '';
            
            const formRows = formActivityTableBody.querySelectorAll('tr');
            formRows.forEach((row, index) => {
                const newRow = previewActivityTableBody.insertRow();
                const cells = row.querySelectorAll('input');
                newRow.innerHTML = `
                    <td>${index + 1}</td><td>${cells[0].value}</td><td>${cells[1].value}</td>
                    <td>${cells[2].value}</td><td>${cells[3].value}</td><td>${cells[4].value}</td>
                    <td>${cells[5].value}</td>`;
            });
            
            const flowchartContainer = document.getElementById('flowchartPreviewContainer');
            flowchartContainer.innerHTML = ''; 

            const flowchartFormRows = document.querySelectorAll('#form-flowchart-table tbody tr');
            const nodes = [];
            flowchartFormRows.forEach(row => {
                 nodes.push({
                    id: row.querySelector('.form-flow-id').value,
                    kegiatan: row.querySelector('.form-flow-kegiatan').value,
                    pelaksana: row.querySelector('.form-flow-pelaksana').value,
                    node: row.querySelector('.form-flow-node').value,
                    idTujuan: row.querySelector('.form-flow-idtujuan').value,
                    idY: row.querySelector('.form-flow-idy').value,
                    idT: row.querySelector('.form-flow-idt').value
                });
            });

            if (nodes.length > 0) {
                let mermaidSyntax = 'graph TD;\n'; 
                nodes.forEach(n => {
                    if (!n.id || !n.kegiatan) return;
                    const sanitizedKegiatan = n.kegiatan.replace(/"/g, '#quot;');
                    const sanitizedPelaksana = n.pelaksana.replace(/"/g, '#quot;');
                    const nodeText = `"${sanitizedKegiatan}<br><i>(${sanitizedPelaksana})</i>"`;
                    switch (n.node) {
                        case 'awal': case 'akhir': mermaidSyntax += `    ${n.id}([${nodeText}]);\n`; break;
                        case 'proses': mermaidSyntax += `    ${n.id}[${nodeText}];\n`; break;
                        case 'keputusan': mermaidSyntax += `    ${n.id}{${nodeText}};\n`; break;
                    }
                });
                nodes.forEach(n => {
                    if (!n.id) return;
                    if (n.node === 'keputusan') {
                        if (n.idY) mermaidSyntax += `    ${n.id} -- YA --> ${n.idY};\n`;
                        if (n.idT) mermaidSyntax += `    ${n.id} -- TIDAK --> ${n.idT};\n`;
                    } else if (n.node !== 'akhir' && n.idTujuan) {
                        mermaidSyntax += `    ${n.id} --> ${n.idTujuan};\n`;
                    }
                });
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidSyntax;
                flowchartContainer.appendChild(mermaidDiv);
                mermaidDiv.removeAttribute('data-processed');
                await mermaid.run({ nodes: [mermaidDiv] });
            }
        };

        updatePreviewBtn.addEventListener('click', () => {
            updatePreview();
            M.toast({html: 'Pratinjau telah diperbarui!'});
        });
        
        // --- MODIFIKASI DIMULAI DI SINI ---
        document.getElementById('generatePdfFromHtml').addEventListener('click', async () => {
            await updatePreview(); 
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageMargin = 15;
            const contentWidth = doc.internal.pageSize.getWidth() - (pageMargin * 2);
            const scaleFactor = 3;
            let yOffset = pageMargin;

            try {
                // Render semua elemen Halaman 1
                const elementsBeforeTable = [document.getElementById('topSectionGrid'), document.getElementById('sopTitleContainer'), ...document.querySelectorAll('.table-like-section')];
                for (const element of elementsBeforeTable) {
                    const canvas = await html2canvas(element, { scale: scaleFactor, useCORS: true });
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const pdfWidth = contentWidth;
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    if (yOffset + pdfHeight > doc.internal.pageSize.getHeight() - pageMargin) { doc.addPage(); yOffset = pageMargin; }
                    doc.addImage(imgData, 'JPEG', pageMargin, yOffset, pdfWidth, pdfHeight);
                    yOffset += pdfHeight + 0.5;
                }
                
                // Render Tabel Kegiatan di Halaman 1
                doc.autoTable({
                    html: '#activityTableData', startY: yOffset, theme: 'grid',
                    margin: { left: pageMargin, right: pageMargin },
                    headStyles: { fillColor: [181, 181, 181], textColor: 0, fontStyle: 'bold', halign: 'center', lineWidth: 0.1, lineColor: [0, 0, 0] },
                    styles: { fontSize: 7, textColor: 0, cellPadding: 1, lineWidth: 0.1, lineColor: [0, 0, 0] },
                });

                // ---- MODIFIKASI UTAMA: Pindahkan Flowchart ke Halaman Baru ----
                // 1. Secara paksa menambahkan halaman baru setelah konten halaman 1 selesai.
                doc.addPage();
                
                // 2. Reset posisi Y ke margin atas untuk halaman baru ini.
                yOffset = pageMargin;
                
                // 3. Render flowchart ke halaman baru.
                const flowchartWrapper = document.createElement('div');
                flowchartWrapper.className = 'pdf-render-wrapper';
                flowchartWrapper.appendChild(document.querySelector('.preview-section-title').cloneNode(true));
                flowchartWrapper.appendChild(document.getElementById('flowchartPreviewContainer').cloneNode(true));
                document.body.appendChild(flowchartWrapper);

                const flowchartCanvas = await html2canvas(flowchartWrapper, { scale: scaleFactor, useCORS: true });
                document.body.removeChild(flowchartWrapper); 

                const flowchartImgData = flowchartCanvas.toDataURL('image/jpeg', 0.95);
                const flowchartPdfWidth = contentWidth;
                const flowchartPdfHeight = (flowchartCanvas.height * flowchartPdfWidth) / flowchartCanvas.width;

                doc.addImage(flowchartImgData, 'JPEG', pageMargin, yOffset, flowchartPdfWidth, flowchartPdfHeight);
                
                // ---- AKHIR MODIFIKASI ----

                doc.output('dataurlnewwindow');

            } catch (error) {
                console.error("Terjadi kesalahan saat membuat PDF:", error);
                M.toast({html: 'Gagal membuat PDF. Cek konsol.', classes: 'red'});
            }
        });
        // --- MODIFIKASI SELESAI DI SINI ---
    </script>
</body>
</html>
